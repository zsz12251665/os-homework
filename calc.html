<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<link rel="stylesheet" href="bootstrap.min.css" />
	<style>
		button:focus, button:focus-visible, button:focus-within { box-shadow: none!important; }
		span.frac { margin: 0 -5%; }
		var { font-family: Georgia, Times, 'Times New Roman', serif; }
	</style>
	<title>A Retro Calculator</title>
</head>
<body class="container">
	<div class="card m-3">
		<div class="card-body">
			<div class="card my-2">
				<div id="display" class="card-body text-end fs-1 font-monospace">0.</div>
			</div>
			<div class="container-fluid">
				<div class="row g-2">
					<div class="col-3"><button id="abs" class="btn btn-lg btn-outline-primary w-100">|<var>x</var>|</button></div>
					<div class="col-3"><button id="square" class="btn btn-lg btn-outline-primary w-100"><var>x</var><sup>2</sup></button></div>
					<div class="col-3"><button id="clear" class="btn btn-lg btn-outline-primary w-100">CE</button></div>
					<div class="col-3"><button id="backspace" class="btn btn-lg btn-outline-primary w-100">&leftarrow;</button></div>
					<div class="col-3"><button id="power" class="btn btn-lg btn-outline-primary w-100"><var>x<sup>y</sup></var></button></div>
					<div class="col-3"><button id="log" class="btn btn-lg btn-outline-primary w-100">log</button></div>
					<div class="col-3"><button id="frac" class="btn btn-lg btn-outline-primary w-100"><sup>1</sup><span class="frac">/</span><sub><var>x</var></sub></button></div>
					<div class="col-3"><button id="divide" class="btn btn-lg btn-outline-primary w-100">&divide;</button></div>
					<div class="col-3"><button id="seven" class="btn btn-lg btn-outline-primary w-100">7</button></div>
					<div class="col-3"><button id="eight" class="btn btn-lg btn-outline-primary w-100">8</button></div>
					<div class="col-3"><button id="nine" class="btn btn-lg btn-outline-primary w-100">9</button></div>
					<div class="col-3"><button id="times" class="btn btn-lg btn-outline-primary w-100">&times;</button></div>
					<div class="col-3"><button id="four" class="btn btn-lg btn-outline-primary w-100">4</button></div>
					<div class="col-3"><button id="five" class="btn btn-lg btn-outline-primary w-100">5</button></div>
					<div class="col-3"><button id="six" class="btn btn-lg btn-outline-primary w-100">6</button></div>
					<div class="col-3"><button id="minus" class="btn btn-lg btn-outline-primary w-100">-</button></div>
					<div class="col-3"><button id="one" class="btn btn-lg btn-outline-primary w-100">1</button></div>
					<div class="col-3"><button id="two" class="btn btn-lg btn-outline-primary w-100">2</button></div>
					<div class="col-3"><button id="three" class="btn btn-lg btn-outline-primary w-100">3</button></div>
					<div class="col-3"><button id="plus" class="btn btn-lg btn-outline-primary w-100">+</button></div>
					<div class="col-3"><button id="sign" class="btn btn-lg btn-outline-primary w-100"><sup>+</sup><span class="frac">/</span><sub>-</sub></button></div>
					<div class="col-3"><button id="zero" class="btn btn-lg btn-outline-primary w-100">0</button></div>
					<div class="col-3"><button id="dot" class="btn btn-lg btn-outline-primary w-100">.</button></div>
					<div class="col-3"><button id="equal" class="btn btn-lg btn-primary w-100">=</button></div>
					<div class="col-6"><button id="import" class="btn btn-lg btn-secondary w-100">import</button></div>
					<div class="col-6"><button id="export" class="btn btn-lg btn-secondary w-100">export</button></div>
				</div>
			</div>
		</div>
	</div>
	<footer class="text-center">
		Now Time: <time class="fst-italic">1970-01-01 00:00:00</time>
	</footer>
	<script>
class Display {
	static MAX_DISPLAY_LENGTH = 14;
	static normalize(v) {
		if (typeof v === 'string')
			v = `0${v}`.replace(/^0*(\d+)/, '$1');
		if (!Number.isFinite(Number(v)))
			return 'Invalid Input';
		v = String(v);
		if (!v.includes('e') && (v[0] !== '-') + v.length + (!v.includes('.')) <= Display.MAX_DISPLAY_LENGTH)
			return v + (v.includes('.') ? '' : '.');
		if (Math.abs(v) < 10 ** (Display.MAX_DISPLAY_LENGTH - 2)) {
			v = Number(v).toPrecision(Display.MAX_DISPLAY_LENGTH - 2);
			return v + (v.includes('.') ? '' : '.');
		} else
			return 'Limit Exceeded';
	}
	constructor(displayElement) {
		this.displayElement = displayElement;
	}
	get text() { return this.displayElement.innerText; }
	set text(v) { this.displayElement.innerText = Display.normalize(v); }
	extendable() { return !this.text.includes(' ') && (this.text[0] !== '-') + this.text.length < Display.MAX_DISPLAY_LENGTH; }
}
class Calculator {
	static unaryOperators = {
		abs: (entry) => Math.abs(entry),
		sign: (entry) => -entry,
		log: (entry) => Math.log10(entry),
		square: (entry) => entry * entry,
		frac: (entry) => 1.0 / entry
	};
	static binaryOperators = {
		plus: (memory, entry) => memory + entry,
		minus: (memory, entry) => memory - entry,
		times: (memory, entry) => memory * entry,
		divide: (memory, entry) => memory / entry,
		power: (memory, entry) => memory ** entry,
		equal: (memory, entry) => entry
	};
	static numeric = {
		zero: '0',
		one: '1',
		two: '2',
		three: '3',
		four: '4',
		five: '5',
		six: '6',
		seven: '7',
		eight: '8',
		nine: '9',
		dot: '.'
	};
	static keyToButtonMap = {
		'0': 'zero',
		'1': 'one',
		'2': 'two',
		'3': 'three',
		'4': 'four',
		'5': 'five',
		'6': 'six',
		'7': 'seven',
		'8': 'eight',
		'9': 'nine',
		'.': 'dot',
		'+': 'plus',
		'-': 'minus',
		'*': 'times',
		'/': 'divide',
		'^': 'power',
		'=': 'equal',
		'Enter': 'equal',
		'|': 'abs',
		'l': 'log',
		'L': 'log',
		'Escape': 'clear',
		'Delete': 'backspace',
		'Backspace': 'backspace',
		's': 'import',
		'S': 'import',
		'o': 'export',
		'O': 'export'
	};
	memory = 0;
	input = '';
	op = 'equal';
	constructor(displayElement) {
		this.display = new Display(displayElement);
	}
	get entry() { return Number(this.display.text); }
	set entry(v) { this.display.text = v; }
	click(id) {
		if (id === 'clear') {
			if (this.input === '') {
				this.memory = 0;
				this.op = 'equal';
			}
			this.input = '';
			this.entry = Number(this.input);
		}
		if (Number.isNaN(this.entry))
			return;
		if (Object.keys(Calculator.unaryOperators).includes(id)) {
			this.entry = Calculator.unaryOperators[id](this.entry);
			this.input = '';
		}
		if (Object.keys(Calculator.binaryOperators).includes(id)) {
			this.entry = Calculator.binaryOperators[this.op](this.memory, this.entry);
			this.memory = this.entry;
			this.input = '';
			this.op = id;
		}
		if (Object.keys(Calculator.numeric).includes(id)) {
			if (this.input === '' || this.display.extendable())
				this.input += Calculator.numeric[id];
			this.display.text = this.input;
		}
		if (id === 'backspace') {
			this.input = this.input.slice(0, -1);
			this.entry = Number(this.input);
		}
		if (id === 'import') {
			window.$openFile()
				.then((text) => {
					if (text !== null) {
						this.click('clear');
						text.split('').forEach((ch) => this.press(ch));
					}
				})
				.catch((err) => { alert(err.message); });
		}
		if (id === 'export') {
			const opToKeyMap = {
				plus: '+',
				minus: '-',
				times: '*',
				divide: '/',
				power: '^',
				equal: '='
			};
			window.$saveFile(`${this.memory}${opToKeyMap[this.op]}${this.input}`)
				.catch((err) => { alert(err.message); });
		}
	}
	press(key) {
		if (Object.keys(Calculator.keyToButtonMap).includes(key))
		this.click(Calculator.keyToButtonMap[key]);
	}
}
var calc = new Calculator(document.querySelector('div#display'));
for (const button of document.querySelectorAll('button'))
	button.addEventListener('click', (e) => { calc.click(e.currentTarget.id); e.currentTarget.blur(); });
document.addEventListener('keyup', (e) => { e.preventDefault(); calc.press(e.key); });
const setTime = () => document.querySelector('time').innerText = window.$now();
setInterval(setTime, 1000);
setTime();
	</script>
</body>
</html>
